---
title: "Deforestation"
subtitle: "Is soybean use driving global deforestation?"
author: "Team 5 Look Alive <br> Krystal Hu, Kate Neal, Owen Henry"
institute: "Duke University"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r load-packages, include = FALSE}
# Add any additional packages you need to this chunk
# Remove any packages from this list that you're not using
library(tidyverse)
library(tidymodels)
library(palmerpenguins)
library(knitr)
library(xaringanthemer)
library(ggdark)
library(scales)
library(viridis)
library(gghighlight)
```

```{r setup, include=FALSE}
# set default theme for ggplot2
ggplot2::theme_set(ggplot2::theme_minimal(base_size = 16))

# For better figure resolution
knitr::opts_chunk$set(
  fig.retina = 3, 
  dpi = 300, 
  fig.width = 6, 
  fig.asp = 0.618, 
  out.width = "70%"
  )
```

```{r load-data, include = FALSE}
forest <- read.csv("../data/forest.csv")
forest_area <- read.csv("../data/forest_area.csv")
brazil_loss <- read.csv("../data/brazil_loss.csv")
vegetable_oil <- read.csv("../data/vegetable_oil.csv")
soybean_use <- read.csv("../data/soybean_use.csv")
```


## Who, What, Why

--
### 1. Who is doing the deforesting?

--

### 2. What is driving the deforestation?

--

### 3. Why is the deforestation happening?

---
## World Forest Data

```{r total_deforestation_by_country, echo=F, message=F}

forest %>% 
  filter(!is.na(code),
         entity != "World") %>%
  ggplot() +
  geom_line(aes(year, net_forest_conversion, color = entity), size = 3) +
  gghighlight(min(-(net_forest_conversion)), max_highlight = 1,
              unhighlighted_params = list(size = 1.2, colour =
                                            alpha("gray", 0.6))) +
  geom_hline(aes(yintercept = 0), color = "red", size = 2) +
  scale_y_continuous(labels = label_number_si()) +
  labs(title = "Net Forest Conversion (hectares)", x = "Year", y = NULL) +
  scale_color_manual(values = c("#009739"))
```


```{r question_1_code, include=F}
forest_data <- merge(forest, forest_area, by=c("code", "year"))

world_soybean_use <- soybean_use %>%
  filter(entity == "World")

world_soybean_total <- world_soybean_use %>%
  rowwise() %>%
  mutate(total = sum(human_food, animal_feed, processed))

brazil_loss$total_brazil_forest_loss_hectares = rowSums(brazil_loss[,5:15])
brazil_loss_soybean_use <- merge(brazil_loss, world_soybean_total, by = c("year")) %>%
  select(year, total_brazil_forest_loss_hectares, total) %>%
  mutate(forest_loss_km2 = -(total_brazil_forest_loss_hectares / 100),
         total_brazil_forest_loss_hectares = - total_brazil_forest_loss_hectares) %>%
  select(-4)

all_soybean_use <- soybean_use %>%
  rowwise() %>%
  mutate(total = sum(human_food, animal_feed, processed, na.rm = T))

soybean_total <- all_soybean_use %>%
  group_by(year) %>%
  summarise(world_soybean_use = sum(total, na.rm = T))

brazil_loss_soybean_use <- brazil_loss_soybean_use %>%
  pivot_longer(!year,
              names_to = "x1",
              values_to = "values")
```

---
## Brazil Forest Loss

```{r cumulative_brazil_only, echo=F}
annotation <- data.frame(
   x = c(2010),
   y = c(-5000000),
   label = c("Brazil has lost")
)
annotation2 <- data.frame(
   x = c(2010),
   y = c(-10200000),
   label = c("over 30 million")
)
annotation3 <- data.frame(
   x = c(2010),
   y = c(-18000000),
   label = c("hectares of forest\nsince 2000")
)

brazil_loss %>% select(year, total_brazil_forest_loss_hectares) %>%
  add_row(year = 2000, total_brazil_forest_loss_hectares = 0, .before = 1) %>%
  mutate(cum_sum = -(cumsum(total_brazil_forest_loss_hectares))) %>%
  ggplot() +
  geom_line(aes(year, cum_sum), size = 2, color = "#009739") +
  geom_hline(aes(yintercept = 0), color = "red", size = 2) +
  labs(title = "Forest loss since 2000 (hectares)", x = "Year", y = NULL) +
  scale_y_continuous(labels = label_number_si()) +
  scale_x_continuous() +
  geom_text(data=annotation, aes(x=x, y=y, label=label),
           color="black", 
           size=7 , angle=0) +
  geom_text(data=annotation2, aes(x=x, y=y, label=label),
           color="red", 
           size=7 , angle=0, fontface="bold") +
  geom_text(data=annotation3, aes(x=x, y=y, label=label),
           color="black", 
           size=7 , angle=0)
```

---
## Causes of Brazil's Deforestation


```{r drivers_of_brazil_deforstation, echo=F}
brazil_loss_no_total <- read.csv("../data/brazil_loss.csv") %>% select(-(1:3))
brazil_loss_no_total <- brazil_loss_no_total %>%
  pivot_longer(!year,
               names_to = "cause",
               values_to = "forest_lost") %>%
  mutate(cause = case_when(
    cause == "pasture" ~ "Pasture",
    cause == "fire" ~ "Fire",
    cause == "commercial_crops" ~ "Commercial Crops",
    cause == "selective_logging" ~ "Selective Logging",
    cause == "small_scale_clearing" ~ "Small-scale Farming",
    T ~ "Other"
  )) %>%
  group_by(cause, year) %>%
  summarise(sum = sum(forest_lost), .groups = 'drop')

ggplot(brazil_loss_no_total, aes(year, sum, fill = cause)) +
  geom_area() +
  scale_fill_manual(values = c("#E69F00", "#56B4E9", "#CC79A7", "#999999", "#0072B2", "#D55E00"))
```

---
## Causes of Brazil's Deforestation


```{r proportion_causes, echo=FALSE, message=F}
#https://www.r-graph-gallery.com/136-stacked-area-chart
brazil_loss_no_total  %>%
  group_by(year, cause) %>%
  summarise(n = sum(sum)) %>%
  mutate(percentage = n / sum(n)) %>%
  ggplot(aes(year, percentage, fill=cause)) + 
    geom_area() +
  scale_fill_manual(values = c("#E69F00", "#56B4E9", "#CC79A7", "#999999", "#0072B2", "#D55E00"))
```

---
## Soybean Use Over Time

```{r soybean_use_continents, echo=F, message=F, warning=F}
soy_use_by_continent <- soybean_use %>%
  filter(entity %in% c('Northern America', 'South America', 'Asia', 'Africa', 'Oceania', 'Europe')) %>%
  mutate(entity = if_else(entity == "Northern America", "North America", entity)) %>%
  rowwise() %>%
  mutate(total = sum(human_food, animal_feed, processed, na.rm = T))

soy_use_by_continent %>%
  ggplot(aes(x = year, y = total, color = entity)) +
  geom_line(show.legend = F, size = 2) +
  gghighlight(max(total), max_highlight = 3, label_params = list(size = 3),
              unhighlighted_params = list(size = 1.2, colour =
                                            alpha("gray", 0.6))) +
  scale_y_continuous(labels = label_number_si()) +
  labs(y=NULL, x = "Year", title = "Tonnes of soybean used", subtitle = "by continent") +
  # okabe ito colors
  scale_color_manual(values = c("#E69F00", "#56B4E9", "#009E73"))
```


---
## Soybean Use Over Time


```{r soybean_use_countries, echo = FALSE, message=F, fig.alt = "interpretation."}
soy_use_by_country <- soybean_use %>%
  filter(!is.na(code),
         entity != "World") %>%
  rowwise() %>%
  mutate(total = sum(human_food, animal_feed, processed, na.rm = T))

# https://stackoverflow.com/questions/49438953/selective-labeling-for-ggplot-lines
# https://cran.r-project.org/web/packages/gghighlight/vignettes/gghighlight.html

soy_use_by_country %>%
  ggplot(aes(x = year, y = total, color = entity)) +
  geom_line(show.legend = F, size = 2) +
  gghighlight(max(total), max_highlight = 4,
              unhighlighted_params = list(size = 1.2, colour =
                                            alpha("gray", 0.6))) +
  scale_y_continuous(labels = label_number_si()) +
  labs(y = NULL, x = "Year", title = "Tonnes of soybean used", subtitle = "by country") +
  # flagcolorcodes.com
  scale_color_manual(values = c("#6CACE4", "#009739", "#EE1C25", "#0A3161"))
```

---
## Plot for Q1

```{r question_1_plot, echo = FALSE, warning = FALSE, fig.alt = "interpretation."}
ggplot(brazil_loss_soybean_use, aes(x = year, y = values)) +
  geom_line(size = 2, color = "#009739") +
  facet_wrap(.~x1, ncol = 1, scales="free_y",
             labeller = as_labeller(c(total = "Worldwide soybean use (tonnes)",
                                    total_brazil_forest_loss_hectares = "Brazil Forest Change (hectares)"))) +
  scale_y_continuous(labels = label_number_si())  +
  ylab(NULL) +
  geom_hline(data = data.frame(yint=0, x1="total_brazil_forest_loss_hectares"), 
             aes(yintercept = yint, color = "red"), show.legend = F)
```


---
class: inverse, middle, center

# Question Two
### How does the proportions of soybean production used for human food versus for feeding animal change over time? Is this change in proportions related to global deforestation development over time?

---

## Plan

--
### 1. Plot global soybean use share by type of usage

--

### 2. Plot the rate of global deforestation during the same time period

--

### 3. Observe and Compare
---
```{r question_2_code, echo = FALSE }
data2 <-soybean_use %>%
  group_by(year) %>%
  summarise(total_human = sum(human_food, na.rm = T),
            total_animal = sum(animal_feed, na.rm = T)) %>%
  pivot_longer(!year, 
              names_to = "use",
              values_to = "amount") 

 data2 <- data2 %>%
   group_by(year) %>%
   mutate(prop = amount / sum(amount))
 
```

## 1. Plot global soybean use share by type of usage

.pull-left[
- Start by grouping all entries in `soybean_use` by decades. For each decade category, add up the values for all entries under `human_food`, `animal_feed`,  and  `processed`.

- Create new variables `prop` that represents the proportions of soybean production used for human food and for animal feed out of the total each decade.

- Plot `prop` filled by the type of use in a stacked bar graph where the x-axis represents `decade` and the y-axis represents proportion percentage between 0 to 1.]

.pull-right[
```{r data2_table, echo = FALSE}
kable(head(data2), format = "html")
```
]
---

## Plot 1
.center[
```{r question_2_plot,fig.align = 'center', echo = FALSE, message = FALSE}
ggplot(data2, aes(fill = use, y = prop, x = year)) + 
  dark_theme_light() +  
  geom_bar(position ="fill", stat ="identity") +
  
  scale_x_continuous (name = "Year",
                     breaks = seq(from = 1961, to = 2013, by = 10)) +
  scale_y_continuous(name = "Proportion",
                     labels = c("0%", "25%", "50%","75%","100%")) +
  scale_fill_manual(values = c("orangered4", "goldenrod1"), 
                    name = NULL, labels = c("Animal food", "Human food")) +
  
  labs(title = "Global soybean production and use share between 1961-2013",
       subtitle = "By types of usage") +
  
  theme(plot.title = element_text(face = 'bold',size = 13),
        plot.subtitle = element_text( size = 12),
        legend.position = "bottom",
        legend.key.size = unit(.5, "cm"),
        legend.text = element_text(size = 10),
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        axis.text.x = element_text( size = 7,face = "bold"),
        axis.text.y = element_text(margin = margin(t = .3, unit = "cm"), size = 7, face = "bold"))
```
]

---
## 2. Plot the rate of global deforestation 

.pull-left[
- Calculate share of global forest area by year
- Plot percentage of global forest area, `forest_area`, as points in the above graph and connect the dots with a distinguishable line. 
]

```{r forest_area__code, echo = FALSE }
forest2 <- forest_area %>%
  filter(year == 1990) %>%
  summarise(total_global = sum(forest_area))

view(forest2)
 
```

.pull-right[
```{r another_table, echo = FALSE}

```

]

---
```{r style-slides, echo = FALSE}
style_xaringan(
  title_slide_background_image = "img/deforestation_back.jpeg"
)
```



---

## Plots

```{r recode-species, echo = FALSE}
# In this chunk I'm doing a bunch of analysis that I don't want to present 
# in my slides. But I need the resulting data frame for a plot I want to present.
penguins_modified <- penguins %>%
  mutate(species = fct_other(species, keep = "Adelie"))
```

```{r plot-penguins, echo = FALSE, warning = FALSE, fig.alt = "Body mass vs. flipper lenght of Palmer Penguins for species Adelie and all the others combined together. There is a relatively strong, positive relationship between the two variables. The Adelie penguins are clustered together but they don't exhibit a different trend than the rest of the penguins."}
# Code hidden with echo = FALSE
# Uses modified penguins dataset from previous chunk
# Play around with height and width until you're happy with the look
ggplot(penguins_modified, aes(x = flipper_length_mm, y = body_mass_g, color = species)) +
  geom_point() + 
  theme_minimal()
```

---


class: inverse, middle, center

# A new section...

---

## Tables

If you want to generate a table, make sure it is in the HTML format (instead of Markdown or other formats), e.g.,

```{r penguins-table, echo = FALSE}
kable(head(penguins), format = "html")
```

---

## Images

```{r castle, echo = FALSE, out.width = "40%", fig.align = "center", fig.cap = "Image credit: Danielle Navarro, Percolate."}
include_graphics("img/watercolour_sys02_img32_percolate.jpg")
```

Or you can also include a full page image. See next slide.

---

background-image: url(img/watercolour_sys02_img32_percolate.jpg)

---

## Math Expressions

You can write LaTeX math expressions inside a pair of dollar signs, e.g. &#36;\alpha+\beta$ renders $\alpha+\beta$. You can use the display style with double dollar signs:

```
$$\bar{X}=\frac{1}{n}\sum_{i=1}^nX_i$$
```

$$\bar{X}=\frac{1}{n}\sum_{i=1}^nX_i$$

Limitations:

1. The source code of a LaTeX math expression must be in one line, unless it is inside a pair of double dollar signs, in which case the starting `$$` must appear in the very beginning of a line, followed immediately by a non-space character, and the ending `$$` must be at the end of a line, led by a non-space character;

1. There should not be spaces after the opening `$` or before the closing `$`.

1. Math does not work on the title slide (see [#61](https://github.com/yihui/xaringan/issues/61) for a workaround).

---

class: inverse, middle, center

# Wrap up

---
